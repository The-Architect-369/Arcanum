name: Verify ArchitectGPT Synchronization

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   # allows committing log updates
  actions: read

jobs:
  verify-sync:
    name: ArchitectGPT Sync Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y grep awk

      - name: Run synchronization verification
        run: |
          chmod +x verify-sync.sh
          ./verify-sync.sh > sync_output.log || true

      - name: Parse results
        id: parse
        run: |
          if grep -q "✅ All synchronization checks passed" sync_output.log; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Append results to .architect-log.md
        run: |
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          CORE_VER=$(grep -m1 "^version:" ArchitectGPT_Core.md | awk '{print $2}')
          EXT_VER=$(grep -m1 "^version:" ArchitectGPT_Extended.md | awk '{print $2}')
          STATUS="${{ steps.parse.outputs.status }}"
          {
            echo ""
            echo "## [AUTO SYNC CHECK — ${DATE}]"
            echo "- Core version: ${CORE_VER}"
            echo "- Extended version: ${EXT_VER}"
            echo "- Result: ${STATUS}"
            echo "- Git commit: $GITHUB_SHA"
            echo "- Triggered by: $GITHUB_ACTOR"
          } >> .architect-log.md

      - name: Commit and push updated log
        if: always()
        run: |
          git config user.name "architect-bot"
          git config user.email "actions@github.com"
          git add .architect-log.md
          git commit -m "Automated sync log update [${{ steps.parse.outputs.status }}]" || echo "No changes to commit"
          git push
